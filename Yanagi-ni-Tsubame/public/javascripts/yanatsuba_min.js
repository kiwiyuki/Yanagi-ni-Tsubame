$(document).ready(function(){var WIDTH=window.innerWidth;var HEIGHT=window.innerHeight;var socket,localData;var scene,camera,renderer,background,player,avatarManager,enemyManager,itemManager,soundManager;var gameDomElement=document.getElementById("game");var bgColor=0x333333;var GAME={};GAME.utils={};GAME.utils.state={LOAD:1,TITLE:2,PLAY:3,GAMEOVER:4};GAME.state=GAME.utils.state.LOAD;GAME.volume=0;socket=io.connect();socket.on("first_message",function(data){console.log(data);scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(45,WIDTH/HEIGHT,1,1500);camera.position.set(0,0,500);camera.lookAt(new THREE.Vector3(0,0,0));scene.fog=new THREE.Fog(bgColor,1250,1500);renderer=new THREE.WebGLRenderer();renderer.setSize(WIDTH,HEIGHT);renderer.setClearColor(bgColor,1);gameDomElement.appendChild(renderer.domElement);var light=new THREE.DirectionalLight(0xffffff,0.95);light.position.set(0,0,1000);scene.add(light);background=new Background();scene.add(background.mesh);localData={};localData.player={};localData.atkEnemys=[];localData.getItems=[];soundManager=new SoundManager(GAME.volume);player=new Player(scene,camera,data.player,soundManager);avatarManager=new AvatarManager(scene,player);avatarManager.update(data.players);enemyManager=new EnemyManager(scene,player,localData.atkEnemys,soundManager);enemyManager.update(data.enemys);itemManager=new ItemManager(scene,player,localData.getItems);itemManager.update(data.items);window.addEventListener('resize',onWindowResize,false);window.addEventListener('keydown',onKeyDown,false);$('#gamevolume').click(onClickVolumeIcon);if(GAME.state==GAME.utils.state.LOAD){gameDomElement.removeChild(document.getElementById("load_msg"));GAME.state=GAME.utils.state.TITLE;}requestAnimationFrame(loop);});socket.on('server_update',function(data){if(GAME.state !=GAME.utils.state.LOAD){for(var i=0;i<data.players.length;i++){if(data.players[i].id==player.id){player.score=data.players[i].score;break;}}avatarManager.update(data.players);enemyManager.update(data.enemys);itemManager.update(data.items);}});socket.json.on("dead_message",function(data){player.mesh.visible=false;player.hp=data.hp;player.score=data.score;GAME.state=GAME.utils.state.GAMEOVER;$("#gameover").removeClass("gameUIHidden");});function loop(){background.update();player.update();avatarManager.animate();enemyManager.localUpdate();itemManager.localUpdate();var bullets=[];player.bullets.forEach(function(b){bullets.push(b.getData());});localData.player={id:player.id,x:player.mesh.position.x,y:player.mesh.position.y,hp:player.hp,state:player.state,bullets:player.bulletsData};if(player.state !="WAIT"){socket.json.emit("player_data",localData);if(player.hp<=0){player.state="WAIT";}}renderer.render(scene,camera);requestAnimationFrame(loop);}function onWindowResize(e){WIDTH=window.innerWidth;HEIGHT=window.innerHeight;renderer.setSize(WIDTH,HEIGHT);camera.aspect=WIDTH/HEIGHT;camera.updateProjectionMatrix();}function onKeyDown(e){if(e.keyCode==13){if(GAME.state==GAME.utils.state.TITLE){GAME.state=GAME.utils.state.PLAY;$("#gametitle").addClass("gameUIHidden");player.state="NORMAL";}else if(GAME.state==GAME.utils.state.GAMEOVER){GAME.state=GAME.utils.state.TITLE;$("#gameover").addClass("gameUIHidden");$("#gametitle").removeClass("gameUIHidden");}}}function onClickVolumeIcon(){if(GAME.volume<=0){GAME.volume=0.5;$('#gamevolume i').removeClass("fa-volume-off");$('#gamevolume i').addClass("fa-volume-down");}else if(GAME.volume<1.0){GAME.volume=1.0;$('#gamevolume i').removeClass("fa-volume-down");$('#gamevolume i').addClass("fa-volume-up");}else if(GAME.volume>=1.0){GAME.volume=0;$('#gamevolume i').removeClass("fa-volume-up");$('#gamevolume i').addClass("fa-volume-off");}soundManager.changeVolume(GAME.volume);};});